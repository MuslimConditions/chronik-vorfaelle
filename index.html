<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Flüchtlingsfeindliche Vorfälle in Deutschland 2015-2016</title>
    <meta name="description" content="Die gemeinsame Chronik der Amadeu Antonio Stiftung und PRO ASYL dokumentiert Übergriffe und Demonstrationen gegen Flüchtlinge und ihre Unterkünfte." />
    <link rel="image_src" href="https://ax3l.github.io/chronik-vorfaelle/img/preview_600x191.png" />

    <!-- Schema.org markup for Google+ (needs additional attributes in <html>)
        <meta itemprop="name" content="Flüchtlingsfeindliche Vorfälle in Deutschland 2015-2016" />
        <meta itemprop="description" content="Die gemeinsame Chronik der Amadeu Antonio Stiftung und PRO ASYL dokumentiert Übergriffe und Demonstrationen gegen Flüchtlinge und ihre Unterkünfte." />
        <meta itemprop="image" content="https://ax3l.github.io/chronik-vorfaelle/img/preview_600x191.png" />
    -->

    <!-- Twitter Card data, https://dev.twitter.com/cards/overview -->
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@AmadeuAntonio" />
    <meta name="twitter:site" content="@ProAsyl" />
    <meta name="twitter:title" content="Flüchtlingsfeindliche Vorfälle in Deutschland 2015-2016" />
    <meta name="twitter:description" content="Die gemeinsame Chronik der Amadeu Antonio Stiftung und PRO ASYL dokumentiert Übergriffe und Demonstrationen gegen Flüchtlinge und ihre Unterkünfte." />
    <meta name="twitter:creator" content="@AmadeuAntonio" />
    <meta name="twitter:creator" content="@ProAsyl" />
    <!-- Twitter Summary card images must be at least 120x120px -->
    <meta name="twitter:image" content="https://ax3l.github.io/chronik-vorfaelle/img/preview_600x191.png" />
    <!-- Twitter summary card with large image must be at least 280x150px -->
    <meta name="twitter:image:src" content="https://ax3l.github.io/chronik-vorfaelle/img/preview_600x191.png" />

    <!-- Open Graph data (most standardized, most important), http://ogp.me/ -->
    <meta property="og:title" content="Flüchtlingsfeindliche Vorfälle in Deutschland 2015-2016" />
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="de_DE" />
    <meta property="og:url" content="https://ax3l.github.io/chronik-vorfaelle/" />
    <!-- <meta property="og:url" content="https://www.mut-gegen-rechte-gewalt.de/chronik-karte" /> -->
    <!-- at least 200x200px, up to 1200x630px recommended -->
    <meta property="og:image" content="https://ax3l.github.io/chronik-vorfaelle/img/preview_600x191.png" />
    <meta property="og:image:type" content="image/png" />
    <meta property="og:image:width" content="600" />
    <meta property="og:image:height" content="191" />
    <meta property="og:description" content="Die gemeinsame Chronik der Amadeu Antonio Stiftung und PRO ASYL dokumentiert Übergriffe und Demonstrationen gegen Flüchtlinge und ihre Unterkünfte." />
    <meta property="og:site_name" content="Mut gegen rechte Gewalt" />
    <!-- <meta property="article:author" content="Amadeu Antonio Stiftung und PRO ASYL" /> needs to be a "profile" type -->
    <meta property="article:section" content="Gesellschaft" />
    <meta property="article:tag" content="Flucht" />
    <meta property="article:tag" content="Refugees" />
    <meta property="article:tag" content="Gewalt" />
    <meta property="article:tag" content="Asyl" />
    <meta property="article:tag" content="kaltland" />
    <!-- <meta property="article:published_time" content="2013-09-17T05:59:00+01:00" />
         <meta property="article:modified_time" content="2013-09-16T19:08:47+01:00" />
    -->
    <!-- <meta property="og:video" content="http://example.com/bond/trailer.swf" />
         <meta property="og:video:type" content="application/x-shockwave-flash" />
         <meta property="og:video:width" content="400" />
         <meta property="og:video:height" content="300" />
    -->

    <!-- style sheets -->
    <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="bower_components/nouislider/distribute/nouislider.min.css" />
    <link rel="stylesheet" href="PruneCluster/dist/LeafletStyleSheet.css" />
    <style type="text/css">
      html, body, #map {
        height: 100%; width: 100%;
        margin: 0;
        padding: 0;
      }

      .prunecluster-small {
        background-color: rgba(225, 200, 35, 0.5);
      }
      .prunecluster-small div {
        background-color: rgba(225, 200, 35, 0.6);
      }
      .prunecluster-medium {
        background-color: rgba(220, 90, 23, 0.5);
      }
      .prunecluster-medium div {
        background-color: rgba(220, 90, 23, 0.5);
      }
      .prunecluster-large {
        background-color: rgba(140, 12, 23, 0.5);
      }
      .prunecluster-large div {
        background-color: rgba(140, 12, 23, 0.6);
      }

      .slider {
        width: 98%;
        margin-bottom: 10px;
      }

      .legend p.dateRange {
        font-weight: bold;
      }
      .legend p.dateRange span.dateCon {
        margin-left:  0.5em;
        margin-right: 0.5em;
      }

      .legend {
        line-height: 50px;
        padding: 0px 10px;
        background: white;
        background: rgba(255,255,255,0.8);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
        border-radius: 8px;
      }
      .legend p {
        margin: 0;
        cursor: pointer;
      }
      .legend img {
        width: 40px;
        height: 40px;
        float: left;
        margin-right: 10px;
        opacity: 0.4;
        filter: alpha(opacity=40); /* msie */
      }
      .legend img.selected {
        opacity: 1.0;
        filter: alpha(opacity=100); /* msie */
      }
      .legend span {
        display: inline-block;
        max-width: 105px;
        line-height: 14px;
        word-wrap: break-word;
      }

      .leaflet-top {
        width: 100%;
      }
      .leaflet-top .title {
        margin: 0;
        width: 100%;
        background: white;
        background: rgba(255,255,255,0.95);
        box-shadow: 0 0 15px rgba(0,0,0,0.2);
      }

      .leaflet-top .title h1 {
        font-size: 20px;
        padding: 1.1em;
        margin: 0;
        font-weight: 800;
      }

      /* .leaflet-top .leaflet-control-zoom {
        margin-top: 3em;
      } */
    </style>

    <script src="bower_components/leaflet/dist/leaflet.js"></script>
    <script src="bower_components/nouislider/distribute/nouislider.min.js"></script>
    <script src="bower_components/wnumb/wNumb.js"></script>
    <script src="PruneCluster/dist/PruneCluster.js"></script>
  </head>

  <body>
    <div id="slida"></div>
    <div id="map"></div>

    <script type="text/javascript">
      var inIframe = (window.location != window.parent.location) ? true : false;

      // init map and zoom to Germany
      var map = L.map('map', {zoomControl: false}).setView([51.5, 11.0], 6);

      // limit panning to Germany
      map.setMaxBounds([
        [60.0, 0.0],
        [40.0, 22.0]
      ]);

      // choose tile backend (OSM)
      L.tileLayer('http://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png',
               // 'http://{s}.tile.osm.org/{z}/{x}/{y}.png',
      {
        minZoom: 6,
        maxZoom: 14,
        attribution: 'Datenquelle: <a href="https://www.mut-gegen-rechte-gewalt.de/service/chronik-vorfaelle">Mut gegen rechte Gewalt</a> (<a href="https://github.com/ax3l/chronik-vorfaelle/archive/data.zip">Download</a>) | CC-BY <a href="https://github.com/ax3l/chronik-vorfaelle/tree/gh-pages/img">Icons</a> | &copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors, Tiles courtesy of <a href="http://hot.openstreetmap.org/" target="_blank">Humanitarian OpenStreetMap Team</a>'
      }).addTo(map);

      // title bar
      var title = L.control({position: 'topleft'});

      title.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'title');
        div.innerHTML = '<h1>Flüchtlingsfeindliche Vorfälle in Deutschland 2015-2016</h1>';
        return div;
      };

      if( !inIframe )
        title.addTo(map);

      // position zoom buttons
      var zoom = L.control.zoom({
          position: 'topleft'
      });

      zoom.addTo(map);

      // categories
      //   0-indexed namings (sorted)
      categories = ["Brandanschlag",
                    "Tätlicher Übergriff/Körperverletzung",
                    "Sonstige Angriffe auf Unterkünfte",
                    "Kundgebung/Demo"];
      //   (unsorted)
      categories_selected = categories.slice();
      //   images (sorted)
      categories_img = ["img/house.svg",
                        "img/attack.svg",
                        "img/clash.svg",
                        "img/demo.svg"];

      var pruneCluster = new PruneClusterForLeaflet(100, 10);
      var markers = [];

      // filter functions for user selection
      var updateFilter = function () {
        // categories to filter (filtered true == do not show)
        //   calculate here: all elements not in categories_selected
        //                   but in categories
        var categories_filtered = categories.filter(function(cat){
          return categories_selected.indexOf(cat) == -1;
        });
        var categories_filtered_idx = categories_filtered.map(function(cat){
          return categories.indexOf(cat);
        });

        // time interval
        var slider = document.getElementsByClassName('slider')[0];

        var date_min = new Date("2015-01-01");   // 01.01.2015
        var date_max = new Date();             // today
        if (slider != null) {
            date_min = new Date(+slider.noUiSlider.get()[0]);
            date_max = new Date(+slider.noUiSlider.get()[1]);
        }
        date_min = date_min.getTime();
        date_max = date_max.getTime();

        var size = markers.length;
        for (var i = 0; i < size; ++i) {
            var is_enabled = new Boolean(true);
            // category filter
            is_enabled = (categories_filtered_idx.indexOf(markers[i].category) == -1);
            // date range filter
            is_enabled &= (markers[i].data.date >= date_min);
            is_enabled &= (markers[i].data.date <= date_max);

            markers[i].filtered = !is_enabled;
        }

        pruneCluster.ProcessView();
      }

      // update time range in legend
      updateTimeRange = function( values, handle ) {
          var dateValues = [
            document.getElementsByClassName('dateMin')[0],
            document.getElementsByClassName('dateMax')[0]
          ];
          if( typeof dateValues[handle] !== "undefined" &&
              typeof dateValues[handle] !== "null" ) {
            dateInt = new Date(+values[handle]);
            dateStr = ("0" + dateInt.getDate()).slice(-2) + "." +
                      ("0" + (dateInt.getMonth() + 1)).slice(-2) + "." +
                      dateInt.getFullYear();
            dateValues[handle].innerHTML = dateStr;
          }
          updateFilter();
      };

      // time slider
      var firstDate = new Date(2015,0,1).getTime();
      var lastDate  = new Date().getTime();
      var time_slider = L.control({position: 'bottomright'});
      time_slider.onAdd = function (map) {
        var slider = L.DomUtil.create('span', 'slider');

        noUiSlider.create(slider, {
          start: [firstDate, lastDate],
          connect: true,
          step: 7 * 24 * 60 * 60 * 1000, // step size: one week
          format: wNumb({
            decimals: 0
          }), // integers only
          range: {
              'min': firstDate,
              'max': lastDate,
          }
        });

        slider.noUiSlider.on('update', updateTimeRange);

        return slider;
      }

      time_slider.addTo(map);

      // legend
      var legend = L.control({position: 'bottomright'});

      var switchCategory = function () {
        var cidx = -1;
        if( this instanceof HTMLImageElement ) {
          var fname = 'img/' + this.src.replace(/^.*[\\\/]/, '');
          cidx = categories_img.indexOf(fname);
        } else {
          var cname = this.textContent.replace(" / ", "/");
          cidx = categories.indexOf(cname);
        }

        var cat = this.parentElement;
        var cname = categories[cidx];
        var img = cat.getElementsByTagName('img')[0];
        if( img.className.indexOf("selected") > -1 ) {
            img.className = "";
            categories_selected.splice(categories_selected.indexOf(cname), 1);
        }
        else {
            img.className = "selected";
            categories_selected.push(cname);
        }
        updateFilter();
      };

      legend.onAdd = function (map) {
        var leg = L.DomUtil.create('div', 'legend');

        var dateRange = L.DomUtil.create('p', 'dateRange');
        var dateMin = L.DomUtil.create('span', 'dateMin');
        var dateCon = L.DomUtil.create('span', 'dateCon');
        var dateMax = L.DomUtil.create('span', 'dateMax');
        dateCon.textContent = "-";
        dateRange.appendChild(dateMin);
        dateRange.appendChild(dateCon);
        dateRange.appendChild(dateMax);
        leg.appendChild(dateRange);

        for( var i = 0; i < categories.length; ++i) {
            var cat = document.createElement("p");

            var img = L.DomUtil.create('img', 'selected');
            img.src = categories_img[i];
            img.onclick = switchCategory;
            cat.appendChild(img);

            var labl = document.createElement("span");
            var text = document.createTextNode(categories[i].replace("/", " / "));
            labl.onclick = switchCategory;
            labl.appendChild(text);
            cat.appendChild(labl)

            leg.appendChild(cat);
        }
        return leg;
      };

      legend.addTo(map);

      // marker helper functions
      function createIcon(data, category) {
        // See http://leafletjs.com/reference.html#icon
        return L.icon({
            iconUrl: categories_img[category],
            iconSize: [50, 50],
            iconAnchor: [25, 50],
            popupAnchor: [0, -30]
            });
      }

      // load JSON
      var xmlhttp = new XMLHttpRequest();
      var url = "https://raw.githubusercontent.com/ax3l/chronik-vorfaelle/data/vorfaelle.geojson";

    xmlhttp.onreadystatechange = function() {
      if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
        var geo_json = JSON.parse(xmlhttp.responseText);
        var vorfaelle = geo_json['features'];

        for(var i=0, l=vorfaelle.length; i<l; ++i) {
          v = vorfaelle[i];
          coord = v['geometry']['coordinates']
          var marker = new PruneCluster.Marker( coord[1], coord[0] );
          // marker.data.name = 'Roger';
          // marker.data.ID = '76ez';
          // number or a string; minimize the performance cost: recommended 0-7
          marker.category = categories.indexOf(v.properties.title);
          marker.data.icon = createIcon;
          // marker.weight = 4;
          // marker.filtered = true|false;
          marker.data.popup = '<b><i>' + v.properties.city + '</i>, ' +
                              v.properties.date + ':</b> ' + v.properties.description +
                              '<br /><b>Quelle:</b> ' + v.properties.source;
          source_href = v.properties.source_href;
          for( h = 0; h < source_href.length; ++h ) {
              marker.data.popup += ' <a href="' + source_href[h]
                                 + '" target="_blank">[' + (h+1) + ']</a>';
          }
          // add date as integer
          date_split = v.properties.date.split(".");
          date_int = new Date(date_split[2] + "-" + date_split[1] + "-" + date_split[0]).getTime();
          marker.data.date = date_int;

          markers.push(marker);
          pruneCluster.RegisterMarker(marker);

          // break;
        }

        // pruneCluster.Cluster.Size = 87;
        // pruneCluster.ProcessView();
        map.addLayer(pruneCluster);
        pruneCluster.RedrawIcons();

        // trigger slider date range
        var slider = document.getElementsByClassName('slider')[0];
        slider.noUiSlider.set(slider.noUiSlider.get());
      }
    }

    xmlhttp.open("GET", url, true);
    xmlhttp.send();
    </script>
  </body>
</html>
